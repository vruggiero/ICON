#!/bin/sh
#
# combine source code into one module
# easier to compile -- no make file needed
#
# pretty generic script -- just echos, cats and greps.
#
#
srcdir=.
if [ ! -z $1 ] ; then
srcdir=$1
fi
PROG=cdilib.c
echo "combining source code into one module"
echo "output is ${PROG}"
#set -x

rm -f ${PROG}

DATE=`date +%F`

if test -f ../configure.ac ; then
   CDILIBVERSION=\"`sed -n '/^AC_INIT(/s/AC_INIT *( *[^,]*,[[ ]*\([^],]*\).*/\1/ p' ../configure.ac`\"
else
   echo "error: cannot find configure.ac" >&2
   exit 1
fi

cat > ${PROG} << EOR

/* Automatically generated by $USER at $DATE, do not edit */

/* CDILIB_VERSION=${CDILIBVERSION} */

/* netCDF only version !!! */

#define HAVE_LIBNETCDF

#if defined(_WIN32) || defined(_WIN64)
#define restrict
#define ssize_t long
#else
#define HAVE_UNISTD_H
#endif

#ifdef _ARCH_PWR6
#pragma options nostrict
#endif

#ifdef  HAVE_CONFIG_H
#include "config.h"
#endif

#ifndef _XOPEN_SOURCE
#define _XOPEN_SOURCE 600
#endif

#ifdef  HAVE_UNISTD_H
#include <unistd.h>
#endif

#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
#include <string.h>
#include <ctype.h>
#include <limits.h>
#include <float.h>
#include <math.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdbool.h>
#include <assert.h>

#ifdef HAVE_LIBGRIB_API
#include <grib_api.h>
#endif

#ifdef HAVE_MMAP
#include <sys/mman.h> /* mmap() is defined in this header */
#endif

#ifdef HAVE_LIBPTHREAD
#include <pthread.h>
#endif

#ifdef HAVE_LIBSZ
#include <szlib.h>
#endif

static void tableDefault(void) {}

EOR

files="basetime.c \
   calendar.c \
   cdf.c \
   cdf_int.c \
   cdf_util.c \
   cdf_lazy_grid.c \
   cdi_cksum.c \
   cdi_error.c \
   cdi_int.c \
   cdi_util.c \
   cksum.c \
   dmemory.c \
   error.c \
   file.c \
   gaussgrid.c \
   grid.c \
   institution.c \
   model.c \
   namespace.c \
   referenceCounting.c \
   resource_handle.c \
   serialize.c \
   stream.c \
   stream_write.c \
   stream_read.c \
   stream_cdf_i.c \
   stream_cdf_o.c \
   stream_cdf_time.c \
   stream_record.c \
   stream_var.c \
   cdf_write.c \
   cdf_read.c \
   subtype.c \
   taxis.c \
   timebase.c \
   tsteps.c \
   util.c \
   varscan.c \
   vlist.c \
   cdi_key.c \
   cdi_att.c \
   vlist_var.c \
   table.c \
   zaxis.c"

car () {
    echo "$1"
}
cdr () {
    shift
    echo "$@"
}
listIncludes () {
    grep '^ *# *include  *"' "$1" | sed 's/^ *# *include  *"\(.*\)".*$/\1/'
}

scanlist="$files"
fileList=
until test "x$scanlist" = "x" ; do
    curFile="$(car $scanlist)"
    scanlist="$(cdr $scanlist)"
    case $curFile in
        (\<*\>)
            fileList="$fileList $(echo "$curFile" | sed 's/<\(.*\)>/\1/')"
            ;;
        (*)
            if echo "$fileList" | grep -q '\<'"$curFile"'\>' ; then
                true    #Nothing to do, we have already scanned this header.
            else
                #Prepend the includes of the current header to the scanlist so that we will scan them in the order that the preprocessor would.
                scanlist="$(listIncludes "$curFile") <$curFile> $scanlist"
            fi
            ;;
    esac
done

echo file list:
echo $fileList

for file in $fileList ; do
  if [ "$file" = "config.h" -o "$file" = "cgribex.h" -o "$file" = "gribapi.h" -o "$file" = "table.h" -o "$file" = "exse.h" -o "$file" = "extra.h" -o "$file" = "ieg.h" -o "$file" = "service.h" -o "$file" = "stream_ext.h" -o "$file" = "stream_ieg.h" -o "$file" = "stream_srv.h" ] ; then
    echo "skipped file: $file"
  else
    cat $srcdir/$file | grep -v '^ *# *include  *"'  >> ${PROG}
  fi
done


cpp -P -DVERSION="${CDILIBVERSION}" -DCDI_H_ \
  $srcdir/version.c >>${PROG}

exit
