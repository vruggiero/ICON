#!/bin/ksh

# ICON
#
# ------------------------------------------
# Copyright (C) 2004-2024, DWD, MPI-M, DKRZ, KIT, ETH, MeteoSwiss
# Contact information: icon-model.org
# See AUTHORS.TXT for a list of authors
# See LICENSES/ for license information
# SPDX-License-Identifier: BSD-3-Clause
# ------------------------------------------

# ===========================================================================
# 
# Name: exp.mch_opr_r04b07_lhn_12_emvorado.run
#
# Purpose: Run script for ICON at on a domain similar to the current COSMO-1E domain
#          This is a low resolution version used for a technical test at MeteoSwiss
#          This setup includes EMVORADO (radar forward operator).
#
# Created by: Fabian Gessler (MeteoSwiss)
#
# =========================================================================== 

set -x

#--------------------------------------------------------------------------------------------------

# (1) Variables provided by the scripting mechanism

# EXPNAME                       = name of exp. in 'exp.<name>'
# basedir                       = base directory, where src/, run/ etc exist
# icon_data_poolFolder          = base directory, where grids/, input/ and setup/ exist
# nproma                        = blocking length for array dimensioning and inner loop lengths

icon_data_poolFolder="${icon_data_rootFolder:-/pool/data/ICON}/mch"

# =======================================================================
# Setup - experiment
# ======================================================================

# ===========================================================================
# This experiment describes a ICON-LAM experiment using the physics packages that are
# used at MeteoSwiss for production. This simulation computes a few time steps on 
# a low-resolution grid over Switzerland. The setup is for development purposes.
# As a new feature lhn_refbias is set by Klaus Stephan to test it on GPU
#
# This experiment includes output of accumulated fluxes.
# ==========================================================================

# ========================
# Some required experiment specific parameters
# =======================

# Folder containing required grid information
grids_folder=${icon_data_poolFolder}/grids/opr_r04b07

# Folder containing lateral boundary conditions
latbc_path=${icon_data_poolFolder}/input/opr_r04b07_lhn_12

dynamics_grid_filename=mch_opr_r4b7_DOM01.nc
atmo_dyn_grids="'${dynamics_grid_filename}',"

radiation_grid_filename=mch_opr_r4b7_DOM01.parent.nc
atmo_rad_grids="'${radiation_grid_filename}',"

# start and end date+time
start_date=${start_date:="2019-06-15T12:00:00Z"}
  end_date=${end_date:="2019-06-15T12:01:00Z"}

# output intervals
output_bounds="0.,10000000.,10."
steps_per_file=7

# namelist files
atmo_namelist=NAMELIST_${EXPNAME}_atm

# settings for EMVORADO
luse_radarfwo=.TRUE.
ydir_mielookup=./MIETABLES/
### unused:
radarinputdir=''
### do not change:
radaroutputdir=./radar_dom1/

ADDITIONAL_SUBDIRS=($radaroutputdir $ydir_mielookup)

# ========================
# Get required files together
# ========================

extpar_filename="external_parameter_icon_mch_opr_r4b7_DOM01_tiles.nc"
add_required_file "${grids_folder}/${extpar_filename}" ./

# files needed for radiation
add_link_file ${basedir}/externals/ecrad/data ecrad_data
add_required_file ${basedir}/data/ECHAM6_CldOptProps.nc rrtm_cldopt.nc
add_required_file ${basedir}/data/rrtmg_lw.nc .

# Dictionary for the mapping: DWD GRIB2 names <-> ICON internal names
add_required_file ${basedir}/run/ana_varnames_map_file.txt map_file.ana

# Dictionary for the mapping: GRIB2/Netcdf input names <-> ICON internal names
add_required_file ${latbc_path}/map_file.latbc map_file.latbc

# initial data
initial_condition=${latbc_path}/ll_2019061512.nc
add_link_file ${initial_condition} .

# lateral boundary grid
add_required_file ${latbc_path}/lateral_boundary.grid.nc lateral_boundary.grid.nc

# lateral boundary data
add_link_file ${latbc_path}/ll_00000000_lbc.nc .
add_link_file ${latbc_path}/ll_00030000_lbc.nc .

# dictionary file for output variable names
dict_file="dict.${EXPNAME}"
cat ${basedir}/run/dict.iconam.mpim  > ${basedir}/run/${dict_file}
add_required_file ${basedir}/run/${dict_file} .


# Add IFS2ICON file
add_link_file ${initial_condition} ifs2icon_file.nc

# ----------------------------------------------------------------------
# Model namelists
# ----------------------------------------------------------------------


cat > ${basedir}/run/${atmo_namelist} << EOF
! parallel_nml: MPI parallelization -------------------------------------------
&parallel_nml
 nproma                      =                   ${nproma}        ! loop chunk length
 nblocks_c                   =                   ${nblocks_c}     ! loop number of cell blocks
 p_test_run                  =                     .FALSE.        ! .TRUE. means verification run for MPI parallelization
 num_io_procs                =                          1         ! number of I/O processors
 num_restart_procs           =                          0         ! number of restart processors
 num_prefetch_proc           =                          1         ! number of processors for LBC prefetching
 iorder_sendrecv             =                          3         ! sequence of MPI send/receive calls
/

! run_nml: general switches ---------------------------------------------------
&run_nml
 ltestcase                   =                     .FALSE.        ! real case run
 num_lev                     =                         80        ! number of full levels (atm.) for each domain
 lvert_nest                  =                     .FALSE.        ! no vertical nesting
 dtime                       =                         10.        ! timestep in seconds
 luse_radarfwo               =            ${luse_radarfwo}        ! EMVORADO
 radarnmlfile                =           "${atmo_namelist}"       ! EMVORADO namelist filename
 ldynamics                   =                      .TRUE.        ! compute adiabatic dynamic tendencies
 ltransport                  =                      .TRUE.        ! compute large-scale tracer transport
 ntracer                     =                          5         ! number of advected tracers
 iforcing                    =                          3         ! forcing of dynamics and transport by parameterized processes
 ldass_lhn                   =                      .TRUE.
 msg_level                   =                         12         ! detailed report during integration
 ltimer                      =                      .TRUE.        ! timer for monitoring the runtime of specific routines
 timers_level                =                         10         ! performance timer granularity
 check_uuid_gracefully       =                      .FALSE.       ! give only warnings for non-matching uuids
 output                      =             "nml", "totint"        ! main switch for enabling/disabling components of the model output
/

! diffusion_nml: horizontal (numerical) diffusion ----------------------------
&diffusion_nml
 lhdiff_vn                   =                      .TRUE.        ! diffusion on the horizontal wind field
 lhdiff_temp                 =                      .TRUE.        ! diffusion on the temperature field
 lhdiff_w                    =                      .TRUE.        ! diffusion on the vertical wind field
 hdiff_order                 =                          5         ! order of nabla operator for diffusion
 itype_vn_diffu              =                          1         ! reconstruction method used for Smagorinsky diffusion
 itype_t_diffu               =                          2         ! discretization of temperature diffusion
 hdiff_efdt_ratio            =                         24.0       ! ratio of e-folding time to time step 
 hdiff_smag_fac              =                          0.025     ! scaling factor for Smagorinsky diffusion
/

! dynamics_nml: dynamical core -----------------------------------------------
&dynamics_nml
 divavg_cntrwgt              =                          0.50      ! weight of central cell for divergence averaging
 lcoriolis                   =                      .TRUE.        ! Coriolis force
/

! extpar_nml: external data --------------------------------------------------
&extpar_nml
 itopo                       =                          1         ! topography (0:analytical)
 extpar_filename             =        "${extpar_filename}"        ! filename of external parameter input file
 n_iter_smooth_topo          =                        1,1         ! iterations of topography smoother
 heightdiff_threshold        =                       3000.        ! height difference between neighb. grid points
 hgtdiff_max_smooth_topo     =                   750.,750.        ! see Namelist doc
 heightdiff_threshold        =                 2250.,1500.
 itype_vegetation_cycle      =                          3         ! gdm orig. 1 tweaks the annual cycle of LAI
/

! initicon_nml: specify read-in of initial state ------------------------------
&initicon_nml
 init_mode                    = 2                          ! For ICON-LAM runs, use 7 when initialized from ICON and 2 from IFS
 ifs2icon_filename            = "ifs2icon_file.nc"
 lread_ana                    = .FALSE.                    ! no analysis data will be read
 lp2cintp_incr                = .FALSE.
 lp2cintp_sfcana              = .FALSE.
 check_ana(1)%list            = 'P','QV','T','U','V'
 check_ana(2)%list            = 'FRESHSNW','H_SNOW','T_SO' ! NOOOOOOOOOOOOO in ens
 use_lakeiceana               = .TRUE.
 qcana_mode                   = 0           ! (0) no QC-increments, 
                                            ! (1) QC+QV-increments added to QV, 
                                            ! (2) QC-increments added to QC if already present at gridpoint
                                            !     and added to QV if not
 qiana_mode                   = 0           ! 0/1: ignore/use QI increments 
 qrsgana_mode                 = 0           ! 0/1: ignore/use QR,QS,QG 
 dwdfg_filename               = "ll_2019061500.nc"    ! initial data filename init_mode 7
 filetype                     = -1        
 ana_varnames_map_file        = "map_file.ana"        ! Dictionary for initial data file
 ltile_coldstart              = .TRUE.  ! coldstart for surface tiles
 ltile_init                   = .FALSE.  ! gdm origin .F. set it to .TRUE. if FG data originate from run without tiles
 pinit_seed                  =                          0         ! seed for perturbation of initial model state. no perturbation by default
 pinit_amplitude             =                          0.        ! amplitude of perturbation
/

! grid_nml: horizontal grid --------------------------------------------------
&grid_nml
 dynamics_grid_filename      =         ${atmo_dyn_grids}        ! array of the grid filenames for the dycore
 radiation_grid_filename     =         ${atmo_rad_grids}        ! array of the grid filenames for the radiation model
 dynamics_parent_grid_id     =                          0         ! array of the indexes of the parent grid filenames
 lredgrid_phys               =                      .TRUE.        ! .true.=radiation is calculated on a reduced grid
 lfeedback                   =                      .TRUE.        ! specifies if feedback to parent grid is performed
 l_limited_area              =                      .TRUE.        ! .TRUE. performs limited area run
 ifeedback_type              =                          2         ! feedback type (incremental/relaxation-based)
 start_time                  =                          0.        ! Time when a nested domain starts to be active [s]
/

! gridref_nml: grid refinement settings --------------------------------------
&gridref_nml
 denom_diffu_v               =                        150.        ! denominator for lateral boundary diffusion of velocity
/

! interpol_nml: settings for internal interpolation methods ------------------
&interpol_nml
 nudge_zone_width            =                         10         ! width of lateral boundary nudging zone
 nudge_max_coeff             =                          0.075     ! maximum relaxation coefficient for lateral boundary nudging
 support_baryctr_intp        =                      .TRUE.        ! barycentric interpolation support for output is enabled for testing (usually not used in LAM)
/

! io_nml: general switches for model I/O -------------------------------------
&io_nml
 output_nml_dict             =              "${dict_file}"        ! translates the output nml names to icon names
 netcdf_dict                 =              "${dict_file}"        ! specifies the names in the output netcdf file
 lnetcdf_flt64_output        =                      .TRUE.        ! double precision output
 itype_pres_msl              =                          2         ! method for computation of mean sea level pressure (Anything < 3 to enable i-level interpolation.)
 itype_rh                    =                          1         ! method for computation of relative humidity
 lmask_boundary              =                      .FALSE.       ! mask out interpolation zone in output
 itype_convindices           =                          2         ! full computation of Most Unstable indeces
 lflux_avg                   =                      .FALSE.       ! the output fluxes are accumulated from the beginning of the run
 dt_diag                     =                         10         ! time interval for writing "total_integrals.dat" (run_nml:output = "totint"). Value reduced for testing.
/

! limarea_nml: settings for limited area mode ---------------------------------
&limarea_nml
 itype_latbc                 =                          1         ! 1: time-dependent lateral boundary conditions
 dtime_latbc                 =                      10800.        ! time difference between 2 consecutive boundary data
 latbc_boundary_grid         =   "lateral_boundary.grid.nc"       ! Grid file defining the lateral boundary
 latbc_path                  =              "${latbc_path}"       ! Absolute path to boundary data
 latbc_varnames_map_file     =            'map_file.latbc'
 latbc_filename              =          'll_<ddhhmmss>_lbc.nc'        ! boundary data input filename
 init_latbc_from_fg          =                     .FALSE.        ! .TRUE.: take lbc for initial time from first guess
/

! lnd_nml: land scheme switches -----------------------------------------------
&lnd_nml
 ntiles                      =                          3         ! number of tiles
 nlev_snow                   =                          3         ! number of snow layers
 lmulti_snow                 =                      .FALSE.       ! .TRUE. for use of multi-layer snow model
 idiag_snowfrac              =                         20         ! type of snow-fraction diagnosis
 lsnowtile                   =                       .TRUE.       ! .TRUE.=consider snow-covered and snow-free separately
 itype_root                  =                          2         ! root density distribution
 itype_heatcond              =                          3         ! type of soil heat conductivity
 itype_lndtbl                =                          4         ! table for associating surface parameters
 itype_evsl                  =                          4         ! type of bare soil evaporation
 itype_root                  =                          2         ! root density distribution
 cwimax_ml                   =                      5.e-4         ! scaling parameter for max. interception storage
 c_soil                      =                       1.25         ! surface area density of the evaporative soil surface
 c_soil_urb                  =                        0.5         ! same for urban areas
 lseaice                     =                     .FALSE.        ! .TRUE. for use of sea-ice model
 llake                       =                      .TRUE.        ! .TRUE. for use of lake model
 itype_canopy                =                          2         ! Jan Peter scheme gdm orig. default 1
 itype_snowevap              =                          3         ! gdm: orig.: 2 Snow evap. in vegetated areas with add. variables for snow age and max. snow height
 itype_trvg                  =                          3         ! BATS scheme with add. prog. var. for integrated plant transpiration since sunrise
 sstice_mode                 =                          2         ! 2: SST is updated on a daily basis by climatological increments
/

! nonhydrostatic_nml: nonhydrostatic model -----------------------------------
&nonhydrostatic_nml
 iadv_rhotheta               =                          2         ! advection method for rho and rhotheta
 ivctype                     =                          2         ! type of vertical coordinate
 itime_scheme                =                          4         ! time integration scheme
 ndyn_substeps               =                          5         ! number of dynamics steps per fast-physics step
 exner_expol                 =                          0.333     ! temporal extrapolation of Exner function
 vwind_offctr                =                          0.2       ! off-centering in vertical wind solver
 damp_height                 =                      12500.0       ! height at which Rayleigh damping of vertical wind starts
 rayleigh_coeff              =                          5.0       ! Rayleigh damping coefficient
 divdamp_order               =                         24         ! order of divergence damping 
 divdamp_type                =                         32         ! gdm default: 3 type of divergence damping
 divdamp_fac                 =                          0.004     ! scaling factor for divergence damping
 igradp_method               =                          3         ! discretization of horizontal pressure gradient
 l_zdiffu_t                  =                      .TRUE.        ! specifies computation of Smagorinsky temperature diffusion
 thslp_zdiffu                =                          0.02      ! slope threshold (temperature diffusion)
 thhgtd_zdiffu               =                        125.0       ! threshold of height difference (temperature diffusion)
 htop_moist_proc             =                      22500.0       ! max. height for moist physics
 hbot_qvsubstep              =                      22500.0       ! height above which QV is advected with substepping scheme
/

! nwp_phy_nml: switches for the physics schemes ------------------------------
&nwp_phy_nml
 inwp_gscp                   =                          2         ! cloud microphysics and precipitation
 inwp_convection             =                          1         ! convection
 lshallowconv_only           =                      .TRUE.        ! only shallow convection
 inwp_radiation              =                          4         ! radiation
 inwp_cldcover               =                          1         ! cloud cover scheme for radiation
 inwp_turb                   =                          1         ! vertical diffusion and transfer
 inwp_satad                  =                          1         ! saturation adjustment
 inwp_sso                    =                          1         ! subgrid scale orographic drag
 inwp_gwd                    =                          0         ! non-orographic gravity wave drag
 inwp_surface                =                          1         ! surface scheme
 latm_above_top              =                      .TRUE.        ! take into account atmosphere above model top for radiation computation
 ldetrain_conv_prec          =                      .TRUE.
 efdt_min_raylfric           =                       7200.        ! minimum e-folding time of Rayleigh friction
 itype_z0                    =                          2         ! type of roughness length data : default, 2: turn off SSO part of z0
 icapdcycl                   =                          3         ! apply CAPE modification to improve diurnalcycle over tropical land
 icpl_aero_conv              =                          1         ! coupling between autoconversion and Tegen aerosol climatology
 icpl_aero_gscp              =                          0         ! coupling between autoconversion and Tegen aerosol climatology
 lrtm_filename               =                'rrtmg_lw.nc'       ! longwave absorption coefficients for RRTM_LW
 cldopt_filename             =             'rrtm_cldopt.nc'       ! RRTM cloud optical properties
 mu_rain                     =                         0.5        ! shap parameter in gamma distribution for rain
 rain_n0_factor              =                         0.1        ! tuning factor for intercept parameter of raindrop size distr.
 dt_rad                      =                          10        ! time step for radiation in s
 dt_conv                     =                          10        ! time step for convection in s (domain specific)
 dt_sso                      =                          10        ! time step for SSO parameterization
 dt_gwd                      =                          10        ! gdm : 360 in guenther
/

! nwp_tuning_nml: additional tuning parameters ----------------------------------
&nwp_tuning_nml
 itune_albedo                =                          1         ! reduced albedo (w.r.t. MODIS data) over Sahara
 tune_gkwake                 =                        0.25
 tune_gfrcrit                =                        0.333
 tune_gkdrag                 =                        0.0
 tune_minsnowfrac            =                        0.3
 tune_box_liq_asy            =                        3.25
 tune_gust_factor            =                        7.25
 tune_zvz0i                  =                        1.25        ! new tuning since June 2018 ! gdm non in guenther
 tune_sgsclifac              =                        1.0         ! new tuning becoming operational in July 2019 ! gdm non in guenther
/

&assimilation_nml
 dace_coupling   = .false.
 dace_debug      = 1
 dace_time_ctrl  = 0,3600,1800 ! [s] time slices of DACE (start, stop, inc)
 fac_lhn_down    = 0.2
 fac_lhn_up      = 1.5
 lhn_artif       = .true.
 lhn_artif_only  = .false.
 lhn_black       = .true.
   blacklist_file  = 'radblack_meteoswiss_extended.nc'
   height_file     = 'radheight_meteoswiss_extended.nc'
   nradar          = 12       ! number of levele with radar heights within height_file
 lhn_bright      = .true.
 lhn_coef        = 1.0
 lhn_diag        = .true.
 lhn_hum_adj     = .true.
 lhn_logscale    = .false.
 lhn_qrs         = .true.
 lhn_relax       = .true.
 lhn_wweight     = .true.
 nlhn_end        = 28800 ! in seconds
 nlhn_relax      = 2
 nlhn_start      = 0
 nlhnverif_end   = 28800
 nlhnverif_start = 0
 radar_in        = '${latbc_path}/'
!radardata_file  = 'radardata_DOM1.nc','radardata_DOM2.nc',
 radardata_file  = 'rad4icon_M01.nc'
 rqrsgmax        = 0.5
 start_fadeout   = 1.0
 std_artif_max   = 4.
 tt_artif_max    = 0.009
 zlev_artif_max  = 3000.
 lhn_refbias     = .true.
/

&output_nml
 output_filename  = "${EXPNAME}_atm_3d"
 filename_format  = "<output_filename>_<levtype_l>_<datetime2>"
 filetype         = 5
 remap            = 0
 output_grid      = .TRUE.
 output_bounds    = ${output_bounds}        ! start, end, increment
 steps_per_file   = ${steps_per_file}
 include_last     = .FALSE.
 ml_varlist       =
  'u','v','vt','qc','qi','qr','qs','qv','rho','theta_v','tke','vn','w',
  'ddt_vn_phy','ddt_exner_phy','ddt_temp_dyn','exner_pr','exner_dyn_incr',
  'pres_sfc','ddt_pres_sfc','temp','tempv','temp_ifc','pres','pres_ifc','dpres_mc',
  'omega','div','div_ic','hdef_ic','dwdx','dwdy','vor','mass_fl_e',
  'rho_ic','w_concorr_c','theta_v_ic','vn_ie','tqv','tqc','tqi','tqr','tqs','rain_gsp_rate','rain_gsp',
  'tot_prec','cape_ml','cin_ml','cape_mu','cin_mu','cape_3km','lfc_ml','lcl_ml','si','sli','swiss12',
  'swiss00','cloudtop','gust10','dyn_gust','clct_mod','cldepth',
  'tot_qv_dia','tot_qc_dia','tot_qi_dia','tqv_dia','tqc_dia','tqi_dia',
  'tsfctrad','thbclr_s','thb_t','thb_s','thu_s','lwflxall','t_s','t_sk','t_so','runoff_s',
  'lwflx_up','lwflx_dn','lwflx_up_clr','lwflx_dn_clr','shfl_s','lhfl_s','lhfl_bs','lhfl_pl','qhfl_s','qcfl_s',
  't_2m','qv_2m','rh_2m','td_2m','u_10m','v_10m','sp_10m','umfl_s','vmfl_s','str_u_sso',
  'str_v_sso','drag_u_grid','ddt_temp_radlw','ddt_temp_turb','ddt_temp_drag',
  'ddt_temp_pconv','ddt_u_turb','ddt_u_sso','ddt_u_pconv','ddt_v_turb','ddt_v_sso',
  'ddt_qv_turb','ddt_qc_turb','ddt_qv_conv','ddt_qc_conv','ddt_tke','ddt_tke_pconv','ddt_tke_hsh','qv_s',
  'runoff_g','plantevap','t_snow','rho_snow','h_snow','freshsnow','ddt_vn_adv','ddt_vn_pgr','exner',
  'dursun', 'dursun_m', 'dursun_r', 'twater', 'dbz', 'dbz_cmax', 'dbz_ctmax', 'dbz_850', 'dbzlmx_low',
  'echotop', 'echotopinm',
  'group:land_vars','group:land_tile_vars','group:dwd_fg_sfc_vars',
  'albdif','clc','clch','clcl','clcm','clct','geopot','gz0','plcov','pv','rh',
  'sdi2', 'ceiling', 'htop_sc', 'hbas_sc', 'smi',
  'accthb_t','accsob_t','accshfl_s','acclhfl_s','accthb_s','accsob_s','accqhfl_s',
  'Q_SEDIM', 'FIS', 'TOPOGRAPHY_C', 'NDVIRATIO', 'TCOND10_MAX', 'TCOND_MAX',
  'UH_MAX', 'UH_MAX_LOW', 'UH_MAX_MED', 'VORW_CTMAX', 'W_CTMAX'
 pl_varlist       =
  'u','v','qc','qi','qr','qs','qv','rho','tke','omega','clc','geopot','dpres_mc','div','vor'
 p_levels         =    10000, 20000, 50000, 100000

 hl_varlist       =
  'tot_qc_dia','tot_qi_dia','ddt_temp_radlw','ddt_temp_turb',
  'ddt_u_pconv','ddt_v_turb','ddt_u_turb','rh', 'pv'
 h_levels             = 5000, 3000, 1500

 il_varlist           = 'rh', 'pv', 'temp',
   'ddt_temp_drag','ddt_temp_pconv','ddt_v_sso','ddt_u_sso'
 i_levels             = 270, 300, 320, 340, 400, 500, 600

/

&output_nml
 output_filename  = "${EXPNAME}_atm_2d_ll"
 filename_format  = "<output_filename>_<levtype_l>_<datetime2>"
 filetype         = 5
 remap            = 1
 output_grid      = .TRUE.
 output_bounds    = ${output_bounds}        ! start, end, increment
 steps_per_file   = ${steps_per_file}
 include_last     = .FALSE.
 ml_varlist       = 't_2m' ! test barycentric lat-lon interpolation
 reg_lon_def      =  2.5,0.2,16.0
 reg_lat_def      = 43.5,0.2,49.0
/

&meteogram_output_nml
 lmeteogram_enabled = .TRUE.
 ldistributed       = .FALSE.
 loutput_tiles      = .TRUE.
 n0_mtgrm           = 0
 ninc_mtgrm         = 1
 stationlist_tot =
   46.95, 7.45, 'Bern',
   47.37, 8.54, 'Zurich',
   46.01, 8.95, 'Lugano',
   46.80, 9.83, 'Davos',
   46.20, 6.15, 'Geneva',
   46.50, 9.84, 'St. Moritz',
   46.14, 7.88, 'Balfrin',
   46.62, 10.29, 'Piz Daint',
   45.98, 7.66, 'Matterhorn',
   45.94, 7.87, 'Monte Rosa',

 max_time_stamps    = 4
 zprefix            = 'Meteogram_'
 var_list           = '  '
/

! radiation_nml: radiation scheme ---------------------------------------------
&radiation_nml
 irad_o3                     =                          79        ! gdm orig. 7 ozone climatology
 irad_aero                   =                          6         ! aerosols
 albedo_type                 =                          2         ! type of surface albedo
 vmr_co2                     =                    390.e-06
 vmr_ch4                     =                   1800.e-09
 vmr_n2o                     =                   322.0e-09
 vmr_o2                      =                     0.20946
 vmr_cfc11                   =                    240.e-12
 vmr_cfc12                   =                    532.e-12
 icld_overlap                =                          2         ! Generalized Random
 ecrad_data_path             =              './ecrad_data'        ! Optical property files path ecRad (link files as path is truncated inside ecrad)
 ecrad_llw_cloud_scat        =                     .TRUE.         ! Longwave cloud scattering
 ecrad_iliquid_scat          =                          0         ! Optical properties used for liquid cloud scattering (0 = SOCRATES)
 ecrad_iice_scat             =                          0         ! Optical properties used for ice cloud scattering (0 = Fu)
 ecrad_isolver               =                          2         ! ISolverMcICAACC
/

! sleve_nml: vertical level specification -------------------------------------
&sleve_nml
 min_lay_thckn               =                         20.0       ! layer thickness of lowermost layer
 top_height                  =                      23000.0       ! height of model top
 stretch_fac                 =                          0.65      ! stretching factor to vary distribution of model levels
 decay_scale_1               =                       4000.0       ! decay scale of large-scale topography component
 decay_scale_2               =                       2500.0       ! decay scale of small-scale topography component
 decay_exp                   =                          1.2       ! exponent of decay function
 flat_height                 =                      16000.0       ! height above which the coordinate surfaces are flat
/

! transport_nml: tracer transport ---------------------------------------------
&transport_nml
 ivadv_tracer                =              3, 3, 3, 3, 3         ! tracer specific method to compute vertical advection
 itype_hlimit                =              3, 4, 4, 4, 4         ! type of limiter for horizontal transport
 itype_vlimit                =              1, 1, 1, 1, 1         ! gdm: 1: semi-monotone slope limiter orig. 2: monotonous type of limiter for vertical transport
 ihadv_tracer                =             52, 2, 2, 2, 2         ! gdm: 52 combination of hybrid FFSL/Miura3 with subcycling
                                                           !     of tracer specific method to compute horizontal advection
 llsq_svd                    =                      .TRUE.        ! use SV decomposition for least squares design matrix
 nadv_substeps               =                          2         ! number of integration steps per fast physics time step
/

! turbdiff_nml: turbulent diffusion -------------------------------------------
&turbdiff_nml
 tkhmin                      =                          0.5       ! scaling factor for minimum vertical diffusion coefficient
 tkmmin                      =                          0.75      ! scaling factor for minimum vertical diffusion coefficient
 pat_len                     =                        750.0       ! effective length scale of thermal surface patterns
 tur_len                     =                        300.0       ! asymptotic maximal turbulent distance
 rat_sea                     =                          7.0       ! controls laminar resistance for sea surface
 ltkesso                     =                        .TRUE.      ! consider TKE-production by sub-grid SSO wakes
 frcsmot                     =                          0.2       ! these 2 switches together apply vertical smoothing of the TKE source terms
 imode_frcsmot               =                            2       ! in the tropics (only), which reduces the moist bias in the tropical lower troposphere
 itype_sher                  =                            2       ! type of shear forcing used in turbulence
 ltkeshs                     =                        .TRUE.      ! include correction term for coarse grids in hor. shear production term
 a_hshr                      =                          2.0       ! length scale factor for separated horizontal shear mode
 icldm_turb                  =                            2       ! mode of cloud water representation in turbulence
 q_crit                      =                          2.0       ! critical value for normalized supersaturation
 imode_tkesso                =                            2       ! mode of calculating th SSO source term for TKE production
 rlam_heat                   =                          1.0       ! gdm default seems to be 10 in code but 1 in Namelist_overview.pdf
/

! ser_nml: serialization configuration ----------------------------------------
&ser_nml
 ser_initialization          =                            0,12,12
 ser_output_diag             =                            0,12,12
 ser_latbc_data              =                            0,12,12
 ser_dynamics                =                            0,12,12
 ser_diffusion               =                            0,12,12 
 ser_step_advection          =                            0,12,12 
 ser_physics                 =                            0,12,12
 ser_surface                 =                            0,12,12
 ser_microphysics            =                            0,12,12
 ser_turbtrans               =                            0,12,12
 ser_turbdiff                =                            0,12,12
 ser_lhn                     =                            0,12,12
 ser_cover                   =                            0,12,12
 ser_radiation               =                            0,12,12
 ser_radheat                 =                            0,12,12
 ser_gwdrag                  =                            0,12,12
 ser_convection              =                            0,12,12
 ser_nudging                 =                            0,12,12 
 ser_nfail                   =                            1
 ser_nreport                 =                            10
 ser_all_debug               =                            0 
 ser_debug                   =                        .FALSE.      ! serialize the debug statements from mo_ser_debug
/

! ----------------------------------------------------------------------
! EMVORADO namelist
! here:
!    no real data input
!    simulated data for one radar + cdfin data output
! be aware: settings are for a german radar in Switzerland
! ----------------------------------------------------------------------

&RADARSIM_PARAMS
!
dom =  1
!
!========================================================
!========================================================
! .. Namelist for the German Weather Radars
!========================================================
!========================================================
!
!========================================================
!
! Number of radar stations to honor from the below list:
!   For each station from ista=1, nradsta_namelist, you can override
!   some meta data in the structures rs_meta(ista) and dbz_meta(ista),
!   which otherwise are taken from the obs files found
!   in the ${radarinputdir} directory resp. the
!   background list. The number of simulated radar stations
!   is determined automatically from the number of files
!   found in the abovementioned ${radarinputdir} directory.
! In this case, nradsta_namelist is NOT the number of radar stations
!   found in the ${radarinputdir} directory
!   but rather the number of stations where you want
!   to change some of the meta data!
!   If you define more change-blocks (see below) than nradsta_namelist, only the
!   first nradsta_namelist blocks will be honored.
! Important: for a correct match of the below change-blocks
!   with the obs radar stations,
!   give the correct station_id for each block below.
!
nradsta_namelist = 1,
!
!========================================================
! Country flag for the observational radar data:
!
!  1 = DWD German radar network       (default)
!  2 = MeteoSwiss Swiss radar network
!
icountry = 1,
!
!
!========================================================
! GLOBAL SETTINGS, I.E., THE SAME FOR ALL RADAR STATIONS:
!========================================================
!
ldebug_radsim = .true.,
lout_geom = .true.,
loutradwind = .true.,
  lfill_vr_backgroundwind = .true.,
loutdbz = .true.,
  lextdbz = .true.,
  ! Global switch to choose itype_refl for all radars.
  !  This is then the background value for all radars, which can
  !  later be overwritten for the single stations via namelist.
  !  If no value or -99 for itype_refl_glob is given, the default
  !  value from dbz_namlst_d (3) will win.
  !  You can override it for each station by individual settings
  !  in the "dbz_meta"- structure below.
  dbz_meta_glob%itype_refl = 1,
  dbz_meta_glob%itype_Dref_fmelt = 1,
  ! Global switch to enable the use of Mie-lookup tables for all radars.
  !  This is then the background value for all radars, which can
  !  later be overwritten for the single stations via namelist.
  dbz_meta_glob%llookup_mie=.true.,
    itype_mpipar_lookupgen = 2,
    pe_start_lookupgen = 1,
    ydir_mielookup_read = '${ydir_mielookup}'
    ydir_mielookup_write = '${ydir_mielookup}'
lweightdbz = .true.,
lfall = .true.,
lonline = .false.,
  lsode =.true.,
  lcomm_nonblocking_online = .true.,
lsmooth = .false.,
  ! Similar to itype_refl_glob, one can define background
  !  values for the number of smoothing points. If -99 or
  !  no values are given, the default
  !  value 1 will win.
  ngpsm_h_glob = 1,
  ngpsm_v_glob = 9,
! Take into account the effects of the minimum detectable signal
!   for reflectivity and/or radial velocity:
!   (There are 2 components of the rs_meta-structure for each radar station which hold
!    the reference MDS, rs_meta%mds_Z0 [dBZ], at a certain reference range, rs_meta%mds_r0 [m].
!    These can be set in the rs_meta-section below. The default is -20 dBZ at 10 km range.)
lmds_z  = .true.,
lmds_vr = .true.,
!
lcomm_nonblocking_output = .TRUE.
!
lvoldata_output = .true.,
  voldata_ostream(1)%format = 'cdfin'  ! 'ascii', 'ascii-gzip', 'f90-binary', 'cdfin', 'cdfin-mulmom', 'grib2', 'grib2-mulmom'
  voldata_ostream(1)%file_pattern = 'cdfin_<stationid>_<varname>_<tvvzstart>-<tvvzend>_<scantype>.nc',
  voldata_ostream(1)%content_dt = 0.0,
  voldata_ostream(1)%content_tref = 0.0,
  voldata_ostream(1)%output_list = 'zrsim', 'vrsim', 'zrobs', 'vrobs',

  voldata_ostream(2)%format = 'cdfin'  ! 'ascii', 'ascii-gzip', 'f90-binary', 'cdfin', 'cdfin-mulmom', 'grib2', 'grib2-mulmom'
  voldata_ostream(2)%file_pattern = 'cdfin_<stationid>_<varname>_<tvvzstart>_<scantype>.nc',
  voldata_ostream(2)%content_dt = 0.0,
  voldata_ostream(2)%content_tref = 0.0,
  voldata_ostream(2)%output_list = 'losim', 'lasim', 'hrsim'

ldo_composite=.false.,
  nel_composite = 1,
  eleindlist_for_composite_glob = 1, 3, 5, ! depends on nel_composite: the first nel_composite entries are used
  ! separate EMVORADO output of composites in dbzcmp_sim* and dbzcmp_obs* files:
  !  (depends on sample files sample_dbzcmp_obs.grb2 and sample_dbzcmp_sim.grb2 in the model start directory)
  lcomposite_output = .TRUE.,

ldo_bubbles = .false.
  eleind_for_composite_bub_glob = 1,

lfdbk_output  = .false.,

! Output directory of all radar files:
ydirradarout = '${radaroutputdir}'

! if lreadmeta_from_netcdf = .true., run in assimilation mode,
!   i.e., radar obs files (NetCDF) are provided and
!   the radar meta data from the files are overtaken.
!   The below listing of meta data does not have any effect!
lreadmeta_from_netcdf = .false.,
  ! Checking and matching of the obs file records
  !   to the obs times individually for each data type file (vr, qv, z, qz)
  !   instead of only taking one of these files for that purpose.
  !   Does not vecorize and takes a long time!
  ! NORMALLY SET TO .FALSE.!!!
  !   Might however help if some records are missing in a
  !   certain file (e.g., for qv) and are present in another file (e.g., vr).
  lcheck_inputrecords = .true.,
  lequal_azi_alldatasets = .true.,
  labort_if_problems_obsfiles = .true.,
  ! Input directory of radar NetCDF files:
  ydirradarin = '${radarinputdir}'
  ! option for superobing for data assimilation: 0: no superobing; 1: averaging;  2: median
  !  (the superobbed fields are stored in the NetCDF feedback files)
  itype_supobing = 1,
    supob_nrb = 3, ! threshold for number of radar bins used for superobbing
    ! resolution of the cartesian grid for superobing [m]: (default: 20000.0)
    supob_cart_resolution = 20000.0,
    ! width of averaging area for superobing [m]: (default: sqrt(2)*20000.0 = 28284.3)
    supob_ave_width = 28284.3,
    ! min. ranges of superobing points for vr and z [m]: (default: 0.75*sqrt(2)*20000.0 = 21213.2)
    supob_minrange_vr = 21213.2,
    supob_minrange_z = 21213.2,
    ! maximal azimut sector (symetrical to its center) for v_r superobing [deg]:
    supob_azi_maxsector_vr = 40.0,
    supob_vrw = 10.0, !(m/s) threshold for stddev of radial wind values within a superobed bi
!      supob_rfl = 1e15, !(mm^6/m^3) threshold for stddev of reflectivity values within a superobed bin
    ! flag for qc control of obs data
    lqc_flag = .false.,
    ! flag for dealiasing of obs radial wind data
    ldealiase_vr_obs = .true.,
    ! lower threshold for valid Ze values, to which smaller valid values are
    !   set before average_superobing. Two thresholds, one for obs and one for sim.
    !   Both should normally be equal and same as corresponding threshold in LETKF software:
    supob_lowthresh_z_obs = 5.0,
    supob_lowthresh_z_sim = 5.0,
  itype_obserr_vr=2
    ramp_lowdbz_obserr_vr=-10.0,
    ramp_highdbz_obserr_vr=10.0,
    maxval_obserr_vr=10.0,
    baseval_obserr_vr=1.0,
  ! if no superobing: step width of data thinning in azimut and range directions for feedback files:
  !  (has no effect in case of superobing!)
  thin_step_azi = 1,
  thin_step_range = 1,
  thin_step_ele = 1,
!
!
!========================================================
!========================================================
! WE HAVE lreadmeta_from_netcdf = .TRUE., THEREFORE
! THE FOLLOWING SETTINGS FOR SINGLE STATIONS ARE ONLY
! TO CHANGE/OVERRIDE META DATA WHICH OTHERWISE COME FROM
! THE OBS DATA FILES OR FROM THE BACKGROUND LIST IN THE
! CODE. IN THE BELOW EXAMPLE, WE WANT TO CHANGE
! SOME METADATA FROM 3 STATIONS.
!
! THIS IS DONE IN BLOCKS: ONE STATION ISTA CORRESPONDS TO
! ONE INDEX OF RS_META(ISTA) AND DBZ_META(ISTA).
! IMPORTANT: ALWAYS SPECIFY THE STATION-ID TO MATCH
! THE CORRECT STATION!
!========================================================
!========================================================
!
!======= List of all radar sites, from which the first nradsta_namelist (s.o.) stations will be changed
!
!
! STATION 1: rs_meta(1) and dbzparams(1): imaginary station
!
  rs_meta(1)%station_name        = 'ZRH'
  rs_meta(1)%station_id          = 99999
  rs_meta(1)%lambda = 0.055
  rs_meta(1)%lat = 47.45033
  rs_meta(1)%lon = 8.56720
  rs_meta(1)%dt_obs = 10
  rs_meta(1)%nobs_times = 7
  dbz_meta(1)%station_id          = 99999  ! (dummy)
!

/

EOF

